<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MHebat! Bila setup Firebase (Config, Rules, Admin Manual) dah siap, kita terus bina **`index.html`** ini.

Kod di bawah adalah **SISTEM LENGKAP** dalam satu fail. Ia merangkumi:
1.  **Database Only:** Gambar ditukar jadi Base64 & dimampatkan (compress) automatik supaya muat dalam Firestore (bawah 1MB).
2.  **Dual Dashboard:** Automatik detect jika login sebagai `admin` atau `customer`.
3.  **Real-time:** Order status, Chat, dan Stok update serta-merta tanpa refresh.
4.  **UI/UX:** Tema "Smooth Glitter Gradient", efek suara, dan responsif penuh.

### Arahan:
1.  Buat fail baru bernama `index.html` di komputer anda.
2.  **Copy & Paste** keseluruhan kod di bawah.
3.  Simpan dan buka fail tersebut di browser (Chrome/Edge) untuk uji.
4.  Untuk online-kan: Upload fail ini ke **GitHub**, lalu sambungkan ke **Vercel**.

```html
<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MFD Showcase | Premium Store</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- TEMA & VISUAL (Gradient & Glitter) --- */
        :root {
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: 1px solid rgba(255, 255, 255, 0.3);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            --text-main: #ffffff;
            --text-secondary: #e0e0e0;
            --accent-color: #ffd700; /* Gold */
            --danger-color: #ff4757;
            --success-color: #2ed573;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-gradient);            background-size: 400% 400%;
            animation: gradientAnim 15s ease infinite;
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Glitter Effect */
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(rgba(255,255,255,0.8) 1px, transparent 1px);
            background-size: 30px 30px;
            opacity: 0.15;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes gradientAnim {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- KOMPONEN GLASSMORPHISM --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: var(--glass-border);
            border-radius: 20px;
            box-shadow: var(--glass-shadow);
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }

        .btn {
            background: rgba(255,255,255,0.9);
            color: #764ba2;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;        }
        .btn:active { transform: scale(0.95); }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-success { background: var(--success-color); color: white; }
        .btn-block { width: 100%; justify-content: center; }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.9);
            outline: none;
            font-family: 'Poppins', sans-serif;
        }
        input:focus { border-color: var(--accent-color); }

        /* --- NAVIGATION --- */
        nav {
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 15px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(118, 75, 162, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        .logo { font-size: 1.4rem; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .nav-icons i { font-size: 1.2rem; margin-left: 15px; cursor: pointer; position: relative; }
        .badge-count {
            position: absolute; top: -8px; right: -8px;
            background: var(--danger-color); color: white;
            font-size: 0.7rem; padding: 2px 6px; border-radius: 50%;
        }

        /* --- SECTIONS & LAYOUT --- */
        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        .section { display: none; animation: fadeIn 0.4s ease-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Product Grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;        }
        @media(min-width: 768px) {
            .product-grid { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        }

        .product-card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            overflow: hidden;
            color: #333;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .product-card:hover { transform: translateY(-5px); }
        .prod-img-box {
            width: 100%; height: 160px;
            background: #eee;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }
        .prod-img-box img { width: 100%; height: 100%; object-fit: cover; }
        .prod-info { padding: 12px; }
        .prod-price { color: #d63031; font-weight: 700; font-size: 1.1rem; }
        .prod-name { font-size: 0.95rem; font-weight: 600; margin: 5px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Tables for Orders/Admin */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.2); font-size: 0.9rem; }
        th { color: var(--accent-color); font-weight: 600; }
        tr:hover { background: rgba(255,255,255,0.05); }

        /* Chat Interface */
        .chat-box {
            height: 60vh;
            display: flex;
            flex-direction: column;
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            overflow: hidden;
        }
        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 10px 15px; border-radius: 15px; font-size: 0.9rem; position: relative; }
        .msg.me { align-self: flex-end; background: white; color: #764ba2; border-bottom-right-radius: 2px; }
        .msg.other { align-self: flex-start; background: rgba(255,255,255,0.2); color: white; border-bottom-left-radius: 2px; }
        .chat-input { display: flex; padding: 10px; background: rgba(255,255,255,0.1); }
        
        /* Utilities */
        .hidden { display: none !important; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }        .st-verified { background: var(--success-color); color: white; }
        .st-pending { background: var(--accent-color); color: #333; }
        .st-cancel { background: var(--danger-color); color: white; }

        /* Modal */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 2000;
            display: none; justify-content: center; align-items: center;
            padding: 20px;
        }
        .modal.open { display: flex; }
        .modal-content {
            background: linear-gradient(135deg, #2d3436, #000);
            width: 100%; max-width: 500px;
            border-radius: 20px; padding: 25px;
            max-height: 90vh; overflow-y: auto;
            border: 1px solid var(--accent-color);
        }
    </style>
</head>
<body>

    <!-- Audio Effects -->
    <audio id="snd-click" src="https://assets.mixkit.co/sfx/preview/mixkit-modern-technology-select-3124.mp3"></audio>
    <audio id="snd-notify" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3"></audio>

    <!-- Navigation -->
    <nav>
        <div class="logo"><i class="fas fa-gem"></i> MFD<span style="color:var(--accent-color)">Showcase</span></div>
        <div class="nav-icons">
            <i class="fas fa-home" onclick="navTo('home')" title="Home"></i>
            <i class="fas fa-shopping-cart" onclick="navTo('cart')" title="Cart">
                <span id="cart-badge" class="badge-count hidden">0</span>
            </i>
            <i class="fas fa-user-circle" onclick="navTo('profile')" title="Profile"></i>
            <i class="fas fa-comments" onclick="navTo('chat')" title="Live Agent"></i>
            <i id="admin-icon" class="fas fa-shield-alt hidden" onclick="navTo('admin-dash')" title="Admin Panel" style="color:var(--accent-color)"></i>
            <i id="logout-icon" class="fas fa-sign-out-alt hidden" onclick="doLogout()" title="Logout"></i>
        </div>
    </nav>

    <div class="container">

        <!-- 1. AUTH SECTION -->
        <div id="auth-section" class="section active">
            <div class="glass-panel" style="max-width: 400px; margin: 50px auto; text-align: center;">
                <h2 id="auth-title" style="margin-bottom: 20px;">Login Account</h2>
                <form id="auth-form">
                    <input type="email" id="auth-email" placeholder="Email Address" required>                    <input type="password" id="auth-pass" placeholder="Password" required>
                    <div id="reg-fields" class="hidden">
                        <input type="text" id="auth-name" placeholder="Full Name (For Purchase)">
                        <input type="tel" id="auth-phone" placeholder="Phone Number (Active)">
                    </div>
                    <button type="submit" class="btn btn-block" style="margin-top: 15px;" id="auth-btn">Login</button>
                </form>
                <p style="margin-top: 15px; font-size: 0.9rem;">
                    <span id="auth-switch-text">New here?</span> 
                    <a href="#" style="color: var(--accent-color); text-decoration: none; font-weight: bold;" onclick="toggleAuthMode()">Create Account</a>
                </p>
            </div>
        </div>

        <!-- 2. HOME / SHOWCASE -->
        <div id="home" class="section">
            <div class="glass-panel" style="text-align: center; margin-bottom: 20px;">
                <h3>üî• Highest Purchase & Recommendations</h3>
                <div style="margin: 15px 0;">
                    <input type="text" id="search-input" placeholder="Search products..." onkeyup="filterProducts()" style="max-width: 300px;">
                </div>
            </div>
            <div id="product-list" class="product-grid">
                <!-- Products injected via JS -->
                <div style="grid-column: 1/-1; text-align: center; padding: 20px;">Loading Showcase...</div>
            </div>
        </div>

        <!-- 3. CART -->
        <div id="cart" class="section">
            <div class="glass-panel">
                <h2><i class="fas fa-shopping-cart"></i> Saved Order Cart</h2>
                <div id="cart-items" style="margin: 20px 0;"></div>
                <div style="text-align: right; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 10px;">
                    <h3>Total: RM <span id="cart-total">0.00</span></h3>
                    <button class="btn btn-success" style="margin-top: 10px;" onclick="goToCheckout()">Check Out</button>
                </div>
            </div>
        </div>

        <!-- 4. CHECKOUT -->
        <div id="checkout" class="section">
            <div class="glass-panel">
                <h2>Confirm Payment</h2>
                <div style="margin: 20px 0; line-height: 1.6;">
                    <p><strong>Total Payable:</strong> RM <span id="checkout-total-display">0.00</span></p>
                    <p><strong>Address:</strong> <span id="checkout-addr">Not Set</span></p>
                    <hr style="border-color: rgba(255,255,255,0.2); margin: 10px 0;">
                    <p style="color: var(--accent-color); font-weight: bold;">Payment Methods:</p>
                    <ul style="margin-left: 20px; font-size: 0.9rem; margin-top: 5px;">                        <li>Online: <a href="https://sociabuzz.com/fareezonzz_019/give" target="_blank" style="color: white;">Sociabuzz Link</a></li>
                        <li>TnG E-Wallet: <strong>161489981218</strong> (Copy & Paste)</li>
                    </ul>
                    <p style="font-size: 0.8rem; color: #ffadad; margin-top: 10px;">
                        ‚ö†Ô∏è Bayar jumlah tepat. Hantar bukti ke WhatsApp +60145400413. Pesanan akan digantung jika tidak disahkan.
                    </p>
                </div>
                <button class="btn btn-block btn-success" onclick="submitOrder()">I Have Paid (Submit Order)</button>
                <button class="btn btn-block" style="margin-top: 10px; background: transparent; border: 1px solid white;" onclick="navTo('cart')">Back</button>
            </div>
        </div>

        <!-- 5. PROFILE & ORDERS (Customer Dashboard) -->
        <div id="profile" class="section">
            <div class="glass-panel">
                <h2>My Account</h2>
                <p>User: <strong id="prof-name">-</strong> (UAC: <strong id="prof-uac">-</strong>)</p>
                <p>Status: <span id="prof-status" class="status-badge st-verified">ACTIVE</span></p>
                <div style="margin-top: 15px;">
                    <label>Shipping Address</label>
                    <textarea id="prof-address" rows="3" placeholder="House No, Street, Unit, Postal Code..."></textarea>
                    <button class="btn" onclick="saveProfile()">Save Changes</button>
                    <button class="btn btn-danger" style="float: right;" onclick="deleteAccount()">Delete Account</button>
                </div>
            </div>

            <!-- Order Tabs -->
            <div class="glass-panel">
                <div style="display: flex; gap: 10px; overflow-x: auto; margin-bottom: 15px; padding-bottom: 5px;">
                    <button class="btn" onclick="showOrderTab('to-pay')">To Pay</button>
                    <button class="btn" onclick="showOrderTab('to-ship')">To Ship</button>
                    <button class="btn" onclick="showOrderTab('completed')">Completed</button>
                    <button class="btn" onclick="showOrderTab('history')">All History</button>
                </div>
                <div id="order-container" class="table-responsive">
                    <!-- Orders injected here -->
                </div>
            </div>
        </div>

        <!-- 6. LIVE CHAT -->
        <div id="chat" class="section">
            <div class="glass-panel chat-box">
                <div style="padding: 10px; background: rgba(0,0,0,0.3); display: flex; justify-content: space-between;">
                    <span>Live Agent Support</span>
                    <span class="status-badge st-verified">Online</span>
                </div>
                <div id="chat-messages" class="chat-messages">
                    <!-- Messages -->
                </div>                <div class="chat-input">
                    <input type="text" id="chat-msg-input" placeholder="Type message..." style="margin:0;">
                    <button class="btn" style="margin-left: 5px;" onclick="sendChat()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <!-- 7. ADMIN DASHBOARD -->
        <div id="admin-dash" class="section">
            <div class="glass-panel" style="border: 1px solid var(--accent-color);">
                <h2 style="color: var(--accent-color);"><i class="fas fa-user-shield"></i> Admin Control Panel</h2>
                <div style="display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap;">
                    <button class="btn" onclick="adminTab('products')">Manage Products</button>
                    <button class="btn" onclick="adminTab('orders')">Manage Orders</button>
                    <button class="btn" onclick="adminTab('users')">Manage Users</button>
                </div>

                <!-- Admin: Add Product -->
                <div id="admin-prod-add" style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h3>Add New Product</h3>
                    <input type="text" id="new-prod-name" placeholder="Item Name">
                    <input type="number" id="new-prod-price" placeholder="Price (RM)">
                    <input type="text" id="new-prod-desc" placeholder="Description">
                    <label style="font-size: 0.8rem;">Product Image (Max 1MB, Auto-compressed)</label>
                    <input type="file" id="new-prod-img" accept="image/*">
                    <button class="btn btn-success" style="margin-top: 10px;" onclick="addProduct()">Upload & Save Product</button>
                </div>

                <!-- Admin Lists -->
                <div id="admin-content-area" class="table-responsive">
                    <!-- Dynamic Content -->
                </div>
            </div>
        </div>

    </div>

    <!-- Product Detail Modal -->
    <div id="prod-modal" class="modal">
        <div class="modal-content">
            <button class="btn" style="float: right; padding: 5px 10px;" onclick="closeModal()">X</button>
            <img id="m-img" src="" style="width: 100%; border-radius: 10px; max-height: 300px; object-fit: contain; background: #000;">
            <h2 id="m-name" style="margin: 10px 0;"></h2>
            <p class="prod-price" id="m-price"></p>
            <p id="m-desc" style="margin: 10px 0; font-size: 0.9rem; color: #ddd;"></p>
            <div style="margin: 15px 0;">
                <label>Quantity:</label>
                <input type="number" id="m-qty" value="1" min="1" max="100" style="width: 80px;">
            </div>
            <button class="btn btn-block btn-success" onclick="addToCartFromModal()">Add to Cart</button>        </div>
    </div>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, where, onSnapshot, serverTimestamp, arrayUnion, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyB-VbrRtyS-Dw1Pprdesn19y9GqBa0p44o",
            authDomain: "mfdshowcase.firebaseapp.com",
            projectId: "mfdshowcase",
            storageBucket: "mfdshowcase.firebasestorage.app",
            messagingSenderId: "173115979759",
            appId: "1:173115979759:web:17ec0c536438e8a776281a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- STATE ---
        let currentUser = null;
        let userData = null;
        let cart = [];
        let isRegister = false;
        let currentProdId = null;

        // --- SOUND FX ---
        const playSound = (id) => {
            const el = document.getElementById(id);
            if(el) { el.currentTime = 0; el.play().catch(()=>{}); }
        };

        // --- AUTH FUNCTIONS ---
        window.toggleAuthMode = () => {
            playSound('click');
            isRegister = !isRegister;
            document.getElementById('auth-title').innerText = isRegister ? 'Register Account' : 'Login Account';
            document.getElementById('auth-btn').innerText = isRegister ? 'Register' : 'Login';
            document.getElementById('reg-fields').classList.toggle('hidden');
            document.getElementById('auth-switch-text').innerText = isRegister ? 'Have an account?' : 'New here?';
            event.target.innerText = isRegister ? 'Login Here' : 'Create Account';
        };

        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            playSound('click');            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const name = document.getElementById('auth-name').value;
            const phone = document.getElementById('auth-phone').value;

            try {
                if (isRegister) {
                    const cred = await createUserWithEmailAndPassword(auth, email, pass);
                    const uac = 'UAC-' + Math.floor(Math.random() * 1000000);
                    await setDoc(doc(db, "users", cred.user.uid), {
                        username: name || email.split('@')[0],
                        fullName: name,
                        phone: phone,
                        email: email,
                        uac: uac,
                        role: 'customer',
                        status: 'ACTIVE',
                        address: '',
                        cart: [],
                        createdAt: serverTimestamp(),
                        lastLogin: serverTimestamp()
                    });
                    alert('Registration Successful! Please Login.');
                    toggleAuthMode(); // Switch back to login
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        });

        window.doLogout = () => {
            playSound('click');
            signOut(auth);
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const snap = await getDoc(doc(db, "users", user.uid));
                if (snap.exists()) {
                    userData = snap.data();
                    // Update UI
                    document.getElementById('auth-section').classList.remove('active');
                    document.getElementById('logout-icon').classList.remove('hidden');
                    document.getElementById('prof-name').innerText = userData.username;
                    document.getElementById('prof-uac').innerText = userData.uac;
                    document.getElementById('prof-status').innerText = userData.status;
                    document.getElementById('prof-address').value = userData.address || '';                    
                    if (userData.role === 'admin') {
                        document.getElementById('admin-icon').classList.remove('hidden');
                    }

                    cart = userData.cart || [];
                    updateCartBadge();
                    loadProducts();
                    listenOrders();
                    listenChat();
                    navTo('home');
                }
            } else {
                currentUser = null;
                userData = null;
                document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
                document.getElementById('auth-section').classList.add('active');
                document.getElementById('logout-icon').classList.add('hidden');
                document.getElementById('admin-icon').classList.add('hidden');
            }
        });

        // --- NAVIGATION ---
        window.navTo = (id) => {
            playSound('click');
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'cart') renderCart();
            if(id === 'profile') showOrderTab('to-pay');
            if(id === 'admin-dash') adminTab('products');
        };

        // --- PRODUCT LOGIC (Base64 Image) ---
        function compressImage(file, callback) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    // Resize logic to keep under 1MB roughly
                    const maxWidth = 800;
                    const scale = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    // Compress to JPEG 0.7 quality
                    callback(canvas.toDataURL('image/jpeg', 0.7));                };
            };
        }

        window.addProduct = async () => {
            playSound('click');
            const name = document.getElementById('new-prod-name').value;
            const price = parseFloat(document.getElementById('new-prod-price').value);
            const desc = document.getElementById('new-prod-desc').value;
            const fileInput = document.getElementById('new-prod-img');

            if (!name || !price || fileInput.files.length === 0) return alert('Fill all fields');

            const file = fileInput.files[0];
            if (file.size > 2000000) return alert('Image too big! Please use smaller image (<2MB).');

            compressImage(file, async (base64Img) => {
                try {
                    await addDoc(collection(db, "products"), {
                        name, price, description: desc,
                        image: base64Img,
                        sold: 0, rating: 5, status: 'Public',
                        createdAt: serverTimestamp()
                    });
                    alert('Product Added!');
                    loadProducts(); // Refresh
                    document.getElementById('new-prod-name').value = '';
                    document.getElementById('new-prod-img').value = '';
                } catch (e) {
                    alert('Error: ' + e.message);
                }
            });
        };

        function loadProducts() {
            const q = query(collection(db, "products"), where("status", "==", "Public"));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('product-list');
                list.innerHTML = '';
                snapshot.forEach(doc => {
                    const p = doc.data();
                    const div = document.createElement('div');
                    div.className = 'product-card';
                    div.onclick = () => openProdModal(doc.id, p);
                    div.innerHTML = `
                        <div class="prod-img-box"><img src="${p.image}" alt="${p.name}"></div>
                        <div class="prod-info">
                            <div class="prod-name">${p.name}</div>
                            <div class="prod-price">RM ${p.price.toFixed(2)}</div>
                            <button class="btn" style="width:100%; margin-top:5px; font-size:0.8rem; padding:5px;">View</button>                        </div>
                    `;
                    list.appendChild(div);
                });
            });
        }

        // --- MODAL & CART ---
        window.openProdModal = (id, data) => {
            playSound('click');
            currentProdId = id;
            document.getElementById('m-name').innerText = data.name;
            document.getElementById('m-price').innerText = 'RM ' + data.price.toFixed(2);
            document.getElementById('m-desc').innerText = data.description;
            document.getElementById('m-img').src = data.image;
            document.getElementById('prod-modal').classList.add('open');
        };

        window.closeModal = () => {
            document.getElementById('prod-modal').classList.remove('open');
        };

        window.addToCartFromModal = () => {
            playSound('click');
            const qty = parseInt(document.getElementById('m-qty').value);
            const prodName = document.getElementById('m-name').innerText;
            const prodPrice = parseFloat(document.getElementById('m-price').innerText.replace('RM ',''));
            const prodImg = document.getElementById('m-img').src;

            // Check if exists
            const existing = cart.find(i => i.id === currentProdId);
            if(existing) {
                existing.qty += qty;
            } else {
                cart.push({ id: currentProdId, name: prodName, price: prodPrice, img: prodImg, qty: qty });
            }
            
            // Save to DB
            updateDoc(doc(db, "users", currentUser.uid), { cart: cart }).then(() => {
                alert('Added to Cart!');
                closeModal();
                updateCartBadge();
            });
        };

        function updateCartBadge() {
            const count = cart.reduce((sum, i) => sum + i.qty, 0);
            const badge = document.getElementById('cart-badge');
            badge.innerText = count;
            badge.classList.toggle('hidden', count === 0);        }

        function renderCart() {
            const container = document.getElementById('cart-items');
            container.innerHTML = '';
            let total = 0;
            if(cart.length === 0) {
                container.innerHTML = '<p>Cart is empty.</p>';
            } else {
                cart.forEach((item, index) => {
                    total += item.price * item.qty;
                    container.innerHTML += `
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px; background:rgba(255,255,255,0.1); padding:10px; border-radius:10px;">
                            <img src="${item.img}" style="width:50px; height:50px; object-fit:cover; border-radius:5px;">
                            <div style="flex:1;">
                                <div>${item.name}</div>
                                <small>RM ${item.price} x ${item.qty}</small>
                            </div>
                            <button class="btn btn-danger" style="padding:5px 10px;" onclick="removeFromCart(${index})">X</button>
                        </div>
                    `;
                });
            }
            document.getElementById('cart-total').innerText = total.toFixed(2);
        }

        window.removeFromCart = (idx) => {
            playSound('click');
            cart.splice(idx, 1);
            updateDoc(doc(db, "users", currentUser.uid), { cart: cart }).then(() => {
                renderCart();
                updateCartBadge();
            });
        };

        // --- CHECKOUT & ORDERS ---
        window.goToCheckout = () => {
            if(cart.length === 0) return alert('Cart empty');
            if(!userData.address) return alert('Please set shipping address in Profile first!');
            
            const total = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
            document.getElementById('checkout-total-display').innerText = total.toFixed(2);
            document.getElementById('checkout-addr').innerText = userData.address;
            navTo('checkout');
        };

        window.submitOrder = async () => {
            playSound('click');
            const total = parseFloat(document.getElementById('checkout-total-display').innerText);
            const orderId = 'ORD-' + Date.now();            
            try {
                await addDoc(collection(db, "orders"), {
                    uid: currentUser.uid,
                    uac: userData.uac,
                    username: userData.username,
                    items: cart,
                    total: total,
                    address: userData.address,
                    paymentStatus: 'Not Verified',
                    deliveryStatus: 'To Pay',
                    trackingNumber: '',
                    orderId: orderId,
                    createdAt: serverTimestamp()
                });
                
                // Clear cart
                cart = [];
                await updateDoc(doc(db, "users", currentUser.uid), { cart: [] });
                updateCartBadge();
                alert('Order Submitted! Wait for Admin Verification.');
                navTo('profile');
                showOrderTab('to-pay');
            } catch(e) {
                alert('Error: ' + e.message);
            }
        };

        function listenOrders() {
            const q = query(collection(db, "orders"), where("uac", "==", userData.uac));
            onSnapshot(q, (snap) => {
                // Handled in showOrderTab
                window.orderSnapshot = snap; 
                if(document.getElementById('profile').classList.contains('active')) {
                    // Refresh current tab
                    const activeTab = document.querySelector('#order-container').dataset.tab || 'to-pay';
                    showOrderTab(activeTab);
                }
                // Admin listener handled separately
                if(userData && userData.role === 'admin') loadAdminOrders();
            });
        }

        window.showOrderTab = (tab) => {
            playSound('click');
            document.getElementById('order-container').dataset.tab = tab;
            const container = document.getElementById('order-container');
            container.innerHTML = '';
            
            if(!window.orderSnapshot) return;
            let html = '<table><thead><tr><th>Item</th><th>Total</th><th>Status</th><th>Track ID</th></tr></thead><tbody>';
            
            window.orderSnapshot.forEach(doc => {
                const o = doc.data();
                let show = false;
                if(tab === 'to-pay' && o.paymentStatus === 'Not Verified') show = true;
                if(tab === 'to-ship' && o.paymentStatus === 'Verified' && o.deliveryStatus !== 'Completed') show = true;
                if(tab === 'completed' && o.deliveryStatus === 'Completed') show = true;
                if(tab === 'history') show = true;

                if(show) {
                    const itemsName = o.items.map(i=>i.name).join(', ').substring(0, 20) + '...';
                    html += `
                        <tr>
                            <td>${itemsName}<br><small>${o.orderId}</small></td>
                            <td>RM ${o.total}</td>
                            <td><span class="status-badge ${o.paymentStatus==='Verified'?'st-verified':'st-pending'}">${o.deliveryStatus}</span></td>
                            <td>${o.trackingNumber || '-'}</td>
                        </tr>
                    `;
                }
            });
            html += '</tbody></table>';
            if(html.includes('<tbody></tbody>')) html = '<p>No orders found.</p>';
            container.innerHTML = html;
        };

        // --- PROFILE UPDATE ---
        window.saveProfile = () => {
            const addr = document.getElementById('prof-address').value;
            updateDoc(doc(db, "users", currentUser.uid), { 
                address: addr,
                lastLogin: serverTimestamp()
            }).then(() => {
                playSound('click');
                alert('Profile Updated');
                userData.address = addr;
            });
        };

        window.deleteAccount = () => {
            if(confirm('Are you sure? This sets status to INACTIVE.')) {
                updateDoc(doc(db, "users", currentUser.uid), { status: 'INACTIVE' });
                signOut(auth);
            }
        };

        // --- CHAT SYSTEM ---
        function listenChat() {            const chatId = `chat_${userData.uac}`; // Simple room ID based on UAC
            const q = query(collection(db, "chats", chatId, "messages")); // Subcollection
            onSnapshot(q, (snap) => {
                const box = document.getElementById('chat-messages');
                // Only re-render if needed to avoid scroll jump, simplified here:
                box.innerHTML = '';
                snap.forEach(doc => {
                    const m = doc.data();
                    const div = document.createElement('div');
                    div.className = `msg ${m.sender === userData.uac ? 'me' : 'other'}`;
                    div.innerText = m.text;
                    box.appendChild(div);
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        window.sendChat = () => {
            const input = document.getElementById('chat-msg-input');
            const txt = input.value;
            if(!txt) return;
            
            const chatId = `chat_${userData.uac}`;
            addDoc(collection(db, "chats", chatId, "messages"), {
                text: txt,
                sender: userData.uac,
                timestamp: serverTimestamp()
            });
            input.value = '';
            playSound('click');
        };

        // --- ADMIN FUNCTIONS ---
        window.adminTab = (tab) => {
            playSound('click');
            const area = document.getElementById('admin-content-area');
            area.innerHTML = '<p>Loading...</p>';
            
            if(tab === 'products') {
                // List products for admin to delete/edit (simplified delete)
                const q = query(collection(db, "products"));
                onSnapshot(q, snap => {
                    let html = '<h3>All Products</h3><table><tr><th>Name</th><th>Price</th><th>Action</th></tr>';
                    snap.forEach(d => {
                        const p = d.data();
                        html += `<tr><td>${p.name}</td><td>${p.price}</td><td><button class="btn btn-danger" onclick="deleteProd('${d.id}')">Delete</button></td></tr>`;
                    });
                    area.innerHTML = html + '</table>';
                });
            } else if (tab === 'orders') {                loadAdminOrders();
            } else if (tab === 'users') {
                const q = query(collection(db, "users"));
                onSnapshot(q, snap => {
                    let html = '<h3>All Users</h3><table><tr><th>UAC</th><th>Name</th><th>Status</th><th>Action</th></tr>';
                    snap.forEach(d => {
                        const u = d.data();
                        html += `<tr><td>${u.uac}</td><td>${u.username}</td><td>${u.status}</td>
                        <td><button class="btn btn-danger" onclick="blockUser('${d.id}')">Block</button></td></tr>`;
                    });
                    area.innerHTML = html + '</table>';
                });
            }
        };

        window.loadAdminOrders = () => {
            const area = document.getElementById('admin-content-area');
            const q = query(collection(db, "orders"));
            onSnapshot(q, snap => {
                let html = '<h3>All Orders (Verify/Update)</h3><table><tr><th>Order ID</th><th>User</th><th>Total</th><th>Pay Status</th><th>Action</th></tr>';
                snap.forEach(d => {
                    const o = d.data();
                    html += `<tr>
                        <td>${o.orderId}</td>
                        <td>${o.username}</td>
                        <td>${o.total}</td>
                        <td>${o.paymentStatus}</td>
                        <td>
                            ${o.paymentStatus === 'Not Verified' ? `<button class="btn btn-success" onclick="verifyOrder('${d.id}')">Verify</button>` : ''}
                            <input type="text" placeholder="Tracking No" id="track-${d.id}" style="width:100px; padding:2px;">
                            <button class="btn" onclick="updateTrack('${d.id}', '${o.deliveryStatus}')">Update Status</button>
                        </td>
                    </tr>`;
                });
                area.innerHTML = html + '</table>';
            });
        };

        window.verifyOrder = (id) => {
            updateDoc(doc(db, "orders", id), { paymentStatus: 'Verified', deliveryStatus: 'To Ship' });
            playSound('click');
        };

        window.updateTrack = (id, currentStatus) => {
            const track = document.getElementById(`track-${id}`).value;
            const nextStatus = prompt("Set Delivery Status (To Ship, To Receive, Completed):", currentStatus);
            if(nextStatus) {
                updateDoc(doc(db, "orders", id), { trackingNumber: track, deliveryStatus: nextStatus });
                playSound('click');
            }        };

        window.deleteProd = (id) => {
            if(confirm('Delete product?')) deleteDoc(doc(db, "products", id));
        };

        window.blockUser = (id) => {
            if(confirm('Block this user?')) updateDoc(doc(db, "users", id), { status: 'BLOCKED' });
        };

    </script>
</body>
</html>
