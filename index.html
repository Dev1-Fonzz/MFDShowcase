<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MFD Store - Recovery Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea, #764ba2, #f093fb); min-height: 100vh; color: #333; }
        .glass { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-radius: 15px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn { background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px; }
        .btn:disabled { opacity: 0.5; }
        input { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .hidden { display: none; }
        .error-msg { color: red; font-size: 0.9em; margin-top: 5px; }
        .success-msg { color: green; font-size: 0.9em; margin-top: 5px; }
        nav { position: sticky; top: 0; z-index: 100; }
    </style>
</head>
<body class="p-4">

    <!-- NAVBAR -->
    <nav class="glass mb-6 flex justify-between items-center">
        <h1 class="text-xl font-bold text-purple-700">MFD STORE</h1>
        <div id="nav-actions">
            <button onclick="showSection('login')" class="text-sm text-purple-600 font-bold mr-2">Login</button>
            <button onclick="logout()" id="btn-logout" class="text-sm text-red-600 font-bold hidden">Logout</button>
        </div>
    </nav>

    <!-- DEBUG CONSOLE (PENTING UNTUK CHECK ERROR) -->
    <div id="debug-console" class="glass mb-4 bg-black text-green-400 text-xs p-2 h-32 overflow-y-auto font-mono">
        <div>> System starting...</div>
    </div>

    <!-- LOGIN SECTION -->
    <section id="login" class="glass max-w-md mx-auto">
        <h2 class="text-2xl font-bold mb-4 text-center">Login</h2>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button onclick="handleLogin()" class="btn">Login</button>
        <p class="text-center mt-4 text-sm">No account? <a href="#" onclick="showSection('register')" class="text-blue-600 underline">Register</a></p>
        <div id="login-msg"></div>
    </section>

    <!-- REGISTER SECTION -->
    <section id="register" class="glass max-w-md mx-auto hidden">
        <h2 class="text-2xl font-bold mb-4 text-center">Register</h2>
        <input type="text" id="reg-name" placeholder="Full Name">        <input type="text" id="reg-phone" placeholder="Phone Number">
        <input type="email" id="reg-email" placeholder="Email">
        <input type="password" id="reg-pass" placeholder="Password">
        <button onclick="handleRegister()" class="btn">Register</button>
        <p class="text-center mt-4 text-sm">Have account? <a href="#" onclick="showSection('login')" class="text-blue-600 underline">Login</a></p>
        <div id="reg-msg"></div>
    </section>

    <!-- DASHBOARD SECTION -->
    <section id="dashboard" class="glass hidden">
        <h2 class="text-2xl font-bold mb-4">Dashboard</h2>
        <div id="user-info" class="mb-4 p-3 bg-purple-50 rounded"></div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="p-4 bg-white rounded shadow">
                <h3 class="font-bold text-lg mb-2">Status Sistem</h3>
                <ul class="text-sm space-y-2">
                    <li>üü¢ Firebase: Connected</li>
                    <li>üü¢ Auth: Active</li>
                    <li>üü° Firestore: Checking...</li>
                </ul>
            </div>
            <div class="p-4 bg-white rounded shadow">
                <h3 class="font-bold text-lg mb-2">Tindakan Pantas</h3>
                <button onclick="testFirestore()" class="btn bg-blue-500">Test Database Connection</button>
                <button onclick="alert('Fitur lain akan ditambah selepas koneksi stabil.')" class="btn bg-gray-500">Lihat Produk (Coming Soon)</button>
            </div>
        </div>
    </section>

    <!-- FIREBASE SDK & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- CONFIGURATION (PASTIKAN INI BETUL) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDMrexlgTwauuqmZ2kZECwqqEYmwtj7Zrs",
            authDomain: "mfd-store.firebaseapp.com",
            projectId: "mfd-store",
            storageBucket: "mfd-store.firebasestorage.app",
            messagingSenderId: "1039564529069",
            appId: "1:1039564529069:web:bc7c752f3618e6cb879524"
        };

        let auth, db;

        // Debug Logger
        function log(msg, type = 'info') {            const consoleDiv = document.getElementById('debug-console');
            const color = type === 'error' ? 'red' : (type === 'success' ? '#0f0' : '#0f0');
            consoleDiv.innerHTML += `<div style="color:${color}">> ${msg}</div>`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            console.log(msg);
        }

        // Initialize Firebase
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            log("‚úÖ Firebase Initialized Successfully");
        } catch (e) {
            log("‚ùå Firebase Init Error: " + e.message, 'error');
            alert("GAGAL SAMBUNG FIREBASE! Sila check Console (F12). Error: " + e.message);
        }

        // Global Functions
        window.showSection = (id) => {
            ['login', 'register', 'dashboard'].forEach(sec => {
                document.getElementById(sec).classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        };

        window.handleLogin = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const msg = document.getElementById('login-msg');
            
            if(!email || !pass) { msg.innerHTML = '<span class="error-msg">Isi email & password</span>'; return; }
            
            try {
                log("Logging in...");
                await signInWithEmailAndPassword(auth, email, pass);
                log("‚úÖ Login successful", 'success');
                msg.innerHTML = '<span class="success-msg">Login berjaya! Mengalih...</span>';
            } catch (e) {
                log("‚ùå Login Error: " + e.code, 'error');
                msg.innerHTML = `<span class="error-msg">Error: ${e.message}</span>`;
            }
        };

        window.handleRegister = async () => {
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            const msg = document.getElementById('reg-msg');
            if(!email || !pass || !name) { msg.innerHTML = '<span class="error-msg">Isi semua field wajib</span>'; return; }

            try {
                log("Registering...");
                const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                const user = userCredential.user;
                
                // Save extra data to Firestore
                const uac = "MFD-" + Math.random().toString(36).substr(2, 6).toUpperCase();
                await setDoc(doc(db, "users", user.uid), {
                    username: name,
                    customerName: name,
                    email: email,
                    phone: phone,
                    uac: uac,
                    role: 'customer',
                    status: 'ACTIVE',
                    address: '',
                    createdAt: serverTimestamp()
                });
                
                log("‚úÖ Registration & DB Write successful", 'success');
                msg.innerHTML = '<span class="success-msg">Daftar berjaya! Sila login.</span>';
                setTimeout(() => showSection('login'), 2000);
            } catch (e) {
                log("‚ùå Register Error: " + e.code, 'error');
                msg.innerHTML = `<span class="error-msg">Error: ${e.message}</span>`;
            }
        };

        window.logout = async () => {
            try {
                await signOut(auth);
                log("üëã Logged out");
                showSection('login');
            } catch (e) {
                log("Logout error: " + e.message, 'error');
            }
        };

        window.testFirestore = async () => {
            if(!auth.currentUser) { alert("Sila login dulu"); return; }
            try {
                log("Testing Firestore write...");
                await addDoc(collection(db, "system_logs"), {
                    test: true,
                    timestamp: serverTimestamp(),
                    user: auth.currentUser.email
                });                alert("‚úÖ SUCCESS! Database connection is working perfectly.");
                log("‚úÖ Firestore test passed", 'success');
            } catch (e) {
                alert("‚ùå FAIL! Database error: " + e.message);
                log("‚ùå Firestore test failed: " + e.message, 'error');
            }
        };

        // Auth State Observer
        onAuthStateChanged(auth, async (user) => {
            const btnLogout = document.getElementById('btn-logout');
            const userInfo = document.getElementById('user-info');
            
            if (user) {
                log(`User logged in: ${user.email}`);
                btnLogout.classList.remove('hidden');
                showSection('dashboard');
                
                // Fetch User Data
                try {
                    const docSnap = await getDoc(doc(db, "users", user.uid));
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        userInfo.innerHTML = `
                            <p><strong>Name:</strong> ${data.customerName || user.email}</p>
                            <p><strong>UAC:</strong> ${data.uac}</p>
                            <p><strong>Status:</strong> ${data.status}</p>
                            <p><strong>Role:</strong> ${data.role}</p>
                        `;
                        log("‚úÖ User data loaded");
                    } else {
                        userInfo.innerHTML = "<p>User data not found in Firestore. Creating...</p>";
                        // Auto-create if missing
                        await setDoc(doc(db, "users", user.uid), {
                            username: user.email.split('@')[0],
                            customerName: user.email.split('@')[0],
                            email: user.email,
                            uac: "NEW-"+Math.random().toString(36).substr(2,6),
                            role: 'customer',
                            status: 'ACTIVE',
                            createdAt: serverTimestamp()
                        });
                    }
                } catch (e) {
                    log("Error loading user data: " + e.message, 'error');
                    userInfo.innerHTML = `<p class="text-red-500">Error loading profile: ${e.message}</p>`;
                }

            } else {
                log("User logged out");                btnLogout.classList.add('hidden');
                showSection('login');
            }
        });

        log("System Ready. Waiting for user action...");
    </script>
</body>
</html>
